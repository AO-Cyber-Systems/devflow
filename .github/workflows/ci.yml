name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"
  RUST_VERSION: "stable"

jobs:
  # ============================================
  # CHANGES DETECTION
  # ============================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.filter.outputs.python }}
      ui: ${{ steps.filter.outputs.ui }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            python:
              - 'devflow/**'
              - 'bridge/**'
              - 'tests/**'
              - 'pyproject.toml'
              - 'requirements*.txt'
            ui:
              - 'ui/**'
            docs:
              - 'docs/**'
              - '*.md'

  # ============================================
  # PYTHON BACKEND
  # ============================================
  python-lint:
    name: Python Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.python == 'true' || github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run black
        run: black --check devflow bridge tests

      - name: Run ruff
        run: ruff check devflow bridge tests

      - name: Run mypy
        run: mypy devflow --ignore-missing-imports
        continue-on-error: true  # TODO: Fix type errors and remove this

  python-test:
    name: Python Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [changes, python-lint]
    if: needs.changes.outputs.python == 'true' || github.event_name == 'push'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: pytest tests/unit -v --tb=short

  # ============================================
  # UI FRONTEND
  # ============================================
  ui-lint:
    name: UI Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.ui == 'true' || github.event_name == 'push'
    defaults:
      run:
        working-directory: ui

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript check
        run: npx tsc --noEmit

  ui-test:
    name: UI Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [changes, ui-lint]
    if: needs.changes.outputs.ui == 'true' || github.event_name == 'push'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    defaults:
      run:
        working-directory: ui

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Vitest tests
        run: npm run test:run

  rust-test:
    name: Rust Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: changes
    if: needs.changes.outputs.ui == 'true' || github.event_name == 'push'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    defaults:
      run:
        working-directory: ui/src-tauri

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ui/src-tauri/target/
          key: ${{ matrix.os }}-cargo-${{ hashFiles('ui/src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ matrix.os }}-cargo-

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Run cargo fmt check
        run: cargo fmt --check

      - name: Run cargo test
        run: cargo test --verbose

  e2e-test:
    name: E2E Test
    runs-on: ubuntu-latest
    needs: [changes, ui-test, rust-test]
    if: needs.changes.outputs.ui == 'true' || github.event_name == 'push'
    defaults:
      run:
        working-directory: ui

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Run Playwright E2E tests
        run: npm run test:e2e -- --project=chromium

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: |
            ui/playwright-report/
            ui/test-results/

  # ============================================
  # STATUS CHECK
  # ============================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [changes, python-test, ui-test, rust-test, e2e-test]
    if: always()
    steps:
      - name: Check all jobs
        env:
          PYTHON_RESULT: ${{ needs.python-test.result }}
          UI_RESULT: ${{ needs.ui-test.result }}
          RUST_RESULT: ${{ needs.rust-test.result }}
          E2E_RESULT: ${{ needs.e2e-test.result }}
        run: |
          if [[ "$PYTHON_RESULT" == "failure" ]] || \
             [[ "$UI_RESULT" == "failure" ]] || \
             [[ "$RUST_RESULT" == "failure" ]] || \
             [[ "$E2E_RESULT" == "failure" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All jobs passed or were skipped"
